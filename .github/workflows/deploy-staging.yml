name: Deploy Staging

on:
  push:
    branches:
      - develop

permissions:
  contents: read
  id-token: write      # Required for OIDC
  security-events: write # Required for Trivy/CodeQL
  actions: read

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }} # thesalo-gallery
  REGION: us-west1
  REPO_NAME: thesalo-repo-staging
  IMAGE_NAME: thesalo-web
  WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
  SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}

jobs:
  # 1. Security Analysis (CodeQL)
  security-check:
    name: CodeQL Logic Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v4
        with:
          languages: python
      - uses: github/codeql-action/autobuild@v4
      - uses: github/codeql-action/analyze@v4

  # 2. Build, Scan & Push (Trivy + Artifact Registry)
  build-and-push:
    name: Build & Trivy Scan
    runs-on: ubuntu-latest
    # needs: security-check # Removed to allow parallel execution
    steps:
      - uses: actions/checkout@v4

      # Auth OIDC
      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v1'
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v1'

      - name: 'Configure Docker Auth'
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      # Build Docker Image
      - name: Build Docker Image
        run: |
          docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
                       -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:latest .

      # Trivy Container Scan
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}'
          format: 'table'
          exit-code: '1' # Fail on High/Critical? 1 = fail
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      # Push if scan passes
      - name: Push Docker Image
        run: |
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:latest

  # 3. Database Migration
  migrate:
    name: DB Migration (Staging)
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip' # Enable caching for pip
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      - name: Run Migration
        env:
          DATABASE_URL: ${{ secrets.SUPABASE_DB_URL_STAGING }}
        run: |
          flask db upgrade

  # 4. Terraform Deploy
  deploy:
    name: Terraform Deploy
    runs-on: ubuntu-latest
    needs: [migrate, security-check] # Ensure security check passes before deploy
    defaults:
      run:
        working-directory: ./terraform/staging/gcp
    steps:
      - uses: actions/checkout@v4

      - id: 'auth'
        uses: 'google-github-actions/auth@v1'
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: terraform plan -var="image_tag=${{ github.sha }}" -input=false
        env:
          TF_VAR_project_id: ${{ env.PROJECT_ID }}
          TF_VAR_region: ${{ env.REGION }}
          TF_VAR_custom_domain: "staging.thesalo-gallery.com"
          TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_db_url: ${{ secrets.SUPABASE_DB_URL_STAGING }}
          TF_VAR_flask_secret: ${{ secrets.FLASK_SECRET_STAGING }}
          TF_VAR_google_client_id: ${{ secrets.GOOGLE_CLIENT_ID_STAGING }}
          TF_VAR_google_client_secret: ${{ secrets.GOOGLE_CLIENT_SECRET_STAGING }}
          TF_VAR_owner_email: ${{ secrets.OWNER_EMAIL }}

      - name: Terraform Apply
        run: terraform apply -var="image_tag=${{ github.sha }}" -auto-approve -input=false
        env:
          TF_VAR_project_id: ${{ env.PROJECT_ID }}
          TF_VAR_region: ${{ env.REGION }}
          TF_VAR_custom_domain: "staging.thesalo-gallery.com"
          TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          # TF_VAR_github_repo is not needed for staging/gcp?
          # Staging GCP main.tf doesn't use gh_oidc module, so it doesn't need github_repo var.
          # BUT it needs sensitive vars defined in tfvars.
          # Secrets should be passed via TF_VAR_xxx env vars from GitHub Secrets?
          # Yes. I need to map GitHub Secrets to TF_VARs here.
          TF_VAR_db_url: ${{ secrets.SUPABASE_DB_URL_STAGING }}
          TF_VAR_flask_secret: ${{ secrets.FLASK_SECRET_STAGING }}
          TF_VAR_google_client_id: ${{ secrets.GOOGLE_CLIENT_ID_STAGING }}
          TF_VAR_google_client_secret: ${{ secrets.GOOGLE_CLIENT_SECRET_STAGING }}
          TF_VAR_owner_email: ${{ secrets.OWNER_EMAIL }}
