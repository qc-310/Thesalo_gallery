name: Deploy Production

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: read
  id-token: write
  security-events: write
  actions: read

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: asia-northeast1
  REPO_NAME: thesalo-repo # Prod repo name
  IMAGE_NAME: thesalo-web
  WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
  SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}

jobs:
  security-check:
    name: CodeQL Logic Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v4
        with:
          languages: python
      - uses: github/codeql-action/autobuild@v4
      - uses: github/codeql-action/analyze@v4

  build-and-push:
    name: Build & Trivy Scan
    runs-on: ubuntu-latest
    needs: security-check
    steps:
      - uses: actions/checkout@v4

      - id: 'auth'
        uses: 'google-github-actions/auth@v1'
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - uses: 'google-github-actions/setup-gcloud@v1'

      - name: 'Configure Docker Auth'
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build Docker Image
        run: |
          docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }} \
                       -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:latest .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      - name: Push Docker Image
        run: |
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:latest

  migrate:
    name: DB Migration (Prod)
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Run Migration
        env:
          DATABASE_URL: ${{ secrets.SUPABASE_DB_URL_PROD }}
        run: flask db upgrade

  deploy:
    name: Terraform Deploy
    runs-on: ubuntu-latest
    needs: migrate
    defaults:
      run:
        working-directory: ./terraform/prod/gcp
    steps:
      - uses: actions/checkout@v4
      - id: 'auth'
        uses: 'google-github-actions/auth@v1'
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0
      - name: Terraform Init
        run: terraform init
      - name: Terraform Plan
        run: terraform plan -var="image_tag=${{ github.ref_name }}" -input=false
        env:
          TF_VAR_project_id: ${{ env.PROJECT_ID }}
          TF_VAR_region: ${{ env.REGION }}
          TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_github_repo: ${{ github.repository }} # Needed for Prod OIDC module
          TF_VAR_db_url: ${{ secrets.SUPABASE_DB_URL_PROD }}
          TF_VAR_flask_secret: ${{ secrets.FLASK_SECRET_PROD }}
          TF_VAR_google_client_id: ${{ secrets.GOOGLE_CLIENT_ID_PROD }}
          TF_VAR_google_client_secret: ${{ secrets.GOOGLE_CLIENT_SECRET_PROD }}
          TF_VAR_owner_email: ${{ secrets.OWNER_EMAIL }}
      - name: Terraform Apply
        run: terraform apply -var="image_tag=${{ github.ref_name }}" -auto-approve -input=false
        env:
          TF_VAR_project_id: ${{ env.PROJECT_ID }}
          TF_VAR_region: ${{ env.REGION }}
          TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_github_repo: ${{ github.repository }} # Needed for Prod OIDC module
          TF_VAR_db_url: ${{ secrets.SUPABASE_DB_URL_PROD }}
          TF_VAR_flask_secret: ${{ secrets.FLASK_SECRET_PROD }}
          TF_VAR_google_client_id: ${{ secrets.GOOGLE_CLIENT_ID_PROD }}
          TF_VAR_google_client_secret: ${{ secrets.GOOGLE_CLIENT_SECRET_PROD }}
          TF_VAR_owner_email: ${{ secrets.OWNER_EMAIL }}
