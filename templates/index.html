{% extends "base.html" %}

{% block content %}

<!-- Upload Card -->
<div class="upload-card">
  <div class="upload-title">
    <h3>æ–°ã—ã„å†™çœŸãƒ»å‹•ç”»ã‚’è¿½åŠ </h3>
  </div>
  <form id="upload-form" class="upload-form" method="post" action="{{ url_for('media.upload') }}"
    enctype="multipart/form-data">
    <!-- Family Select Logic could go here if multiple families -->

    <label class="btn btn-secondary file-input-wrapper">
      <span>ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ...</span>
      <input type="file" name="file" id="file-input" class="file-input" accept="image/*,video/*" multiple required
        style="position:absolute;left:0;top:0;opacity:0;width:100%;height:100%;cursor:pointer;">
    </label>

    <!-- File Preview Container -->
    <div id="file-preview-container"
      style="display:none; margin-top: 10px; text-align: center; background: #f0f0f0; padding: 10px; border-radius: 8px; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px;">
    </div>

    <button id="upload-btn" class="btn btn-primary" type="submit">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
  </form>
</div>

<!-- Masonry Grid -->
<div class="masonry-grid">
  {% for m in media_list %}
  <div class="grid-item fade-in" style="animation-delay: {{ loop.index0 * 0.05 }}s" data-id="{{ m.id }}">

    <!-- Menu -->
    <!-- Logic for edit/delete pending implementation in media_bp -->
    <!-- 
        <button class="menu-btn" type="button">â‹¯</button>
        <div class="menu-dropdown">
           ...
        </div>
        -->

    <!-- Media -->
    <!-- Determine type helper in template or model property -->
    {% set m_type = 'video' if m.mime_type.startswith('video') else 'image' %}

    <div class="media-wrapper media-trigger" data-type="{{ m_type }}"
      data-src="{{ url_for('media.serve_file', filename=m.filename) }}" onclick="openLightbox({{ loop.index0 }})">

      {% if m_type == "image" %}
      <img class="grid-media" src="{{ url_for('media.serve_file', filename=m.filename) }}" loading="lazy" alt="">
      {% elif m_type == "video" %}
      {% set thumb = m.thumbnail_path and url_for('media.serve_thumbnail', filename=m.thumbnail_path) or
      url_for('media.serve_file',
      filename=m.filename) %}
      <img class="grid-media" src="{{ thumb }}" loading="lazy" alt="Video Thumbnail">
      <div class="play-icon">â–¶</div>
      <div class="video-badge">VIDEO</div>
      {% endif %}
    </div>

    <!-- Info -->
    <div class="item-info">
      <!-- Comment not yet carried over to new model? Added later -->
      <div class="item-meta">
        {{ (m.taken_at or m.created_at)|string }}
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Infinite Scroll Sentinel -->
<div id="scroll-sentinel" style="height: 50px; text-align: center; color: #999; margin-top: 20px;"></div>

{% endblock %}