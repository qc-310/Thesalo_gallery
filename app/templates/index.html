{% extends "base.html" %}

{% block content %}

<!-- Floating Upload Button -->
{% if current_user.is_family %}
<a href="{{ url_for('media.upload_page') }}" class="fab-btn" title="ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰">
  +
</a>
{% endif %}

<!-- Edit Media Modal -->
<div id="edit-modal" class="lightbox" style="z-index: 1001;">
  <div class="edit-modal-content">
    <button class="lightbox-close"
      style="top: 10px; right: 10px; width: 32px; height: 32px; font-size: 20px; color: var(--text-secondary); background: transparent;"
      onclick="closeEditModal()">Ã—</button>
    <!-- Preview Image (Absolute Positioned) -->
    <img id="edit-preview-image" class="edit-preview-img" src="" alt=""
      style="display: none; position: absolute; top: 24px; right: 60px; width: 120px; height: 120px; object-fit: cover; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);"
      onerror="this.style.display='none'" onload="this.style.display='block'">

    <h3 style="margin-bottom: 20px; color: var(--text-primary); max-width: calc(100% - 140px);">è©³ç´°ã‚’ç·¨é›†</h3>

    <form id="edit-media-form" onsubmit="submitEdit(event)">
      <input type="hidden" id="edit-media-id">

      <div style="margin-bottom: 16px; max-width: calc(100% - 140px);">
        <label style="display: block; font-weight: bold; margin-bottom: 8px; color: var(--text-secondary);">æ’®å½±æ—¥æ™‚</label>
        <!-- Using type="datetime-local" for easy picking, though taken_at is stored as ISO string -->
        <input type="datetime-local" id="edit-taken-at" name="taken_at"
          style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 8px; width: 220px !important;">
      </div>

      <div>
        <label style="display: block; font-weight: bold; margin-bottom: 8px; color: var(--text-secondary);">ã‚³ãƒ¡ãƒ³ãƒˆ</label>
        <textarea id="edit-description" name="description" rows="4" placeholder="æ€ã„å‡ºã®ä¸€è¨€..."
          style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 8px; width: 100%;"></textarea>
      </div>

      <div style="display: flex; justify-content: space-between; align-items: center;">
        <button type="button" class="btn btn-danger" onclick="deleteMedia()"
          style="background-color: var(--color-danger); color: white; border: none;">å‰Šé™¤</button>
        <div style="display: flex; gap: 12px;">
          <button type="button" class="btn btn-secondary" onclick="closeEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="submit" class="btn btn-primary">ä¿å­˜ã™ã‚‹</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Filter/Sort Bar -->
<div
  style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">

  <!-- Filter Pills (Left) -->
  <div style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; align-items: center;">
    {% set current_sort = request.args.get('sort', 'created_at_desc') %}
    {% set current_type = request.args.get('type', 'all') %}

    <a href="{{ url_for('core.index', type='all', sort=current_sort) }}"
      class="btn {{ 'btn-primary' if current_type == 'all' else 'btn-secondary' }}"
      style="padding: 6px 16px; font-size: 13px; border-radius: 20px; white-space: nowrap;">
      ã™ã¹ã¦
    </a>
    <a href="{{ url_for('core.index', type='favorites', sort=current_sort) }}"
      class="btn {{ 'btn-primary' if current_type == 'favorites' else 'btn-secondary' }}"
      style="padding: 6px 16px; font-size: 13px; border-radius: 20px; white-space: nowrap;">
      â™¥ ãŠæ°—ã«å…¥ã‚Š
    </a>
    <a href="{{ url_for('core.index', type='image', sort=current_sort) }}"
      class="btn {{ 'btn-primary' if current_type == 'image' else 'btn-secondary' }}"
      style="padding: 6px 16px; font-size: 13px; border-radius: 20px; white-space: nowrap;">
      å†™çœŸã®ã¿
    </a>
    <a href="{{ url_for('core.index', type='video', sort=current_sort) }}"
      class="btn {{ 'btn-primary' if current_type == 'video' else 'btn-secondary' }}"
      style="padding: 6px 16px; font-size: 13px; border-radius: 20px; white-space: nowrap;">
      å‹•ç”»ã®ã¿
    </a>
    <a href="{{ url_for('core.index', type='mine', sort=current_sort) }}"
      class="btn {{ 'btn-primary' if current_type == 'mine' else 'btn-secondary' }}"
      style="padding: 6px 16px; font-size: 13px; border-radius: 20px; white-space: nowrap;">
      è‡ªåˆ†ã®æŠ•ç¨¿
    </a>
  </div>

  <!-- Sort Control (Right) -->
  <div style="display: flex; align-items: center;">
    <form action="{{ url_for('core.index') }}" method="get"
      style="display: flex; align-items: center; gap: 8px; margin: 0;">
      <input type="hidden" name="type" value="{{ request.args.get('type', 'all') }}">
      <label style="font-size: 12px; color: var(--text-secondary); font-weight: 600; white-space: nowrap;">ä¸¦ã³æ›¿ãˆ:</label>
      <select name="sort" onchange="this.form.submit()" class="nav-select"
        style="padding: 6px 12px; border-radius: 8px; font-size: 13px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary);">
        <option value="created_at_desc" {% if request.args.get('sort')=='created_at_desc' or not
          request.args.get('sort') %}selected{% endif %}>è¿½åŠ æ—¥ (æ–°ã—ã„é †)</option>
        <option value="created_at_asc" {% if request.args.get('sort')=='created_at_asc' %}selected{% endif %}>è¿½åŠ æ—¥ (å¤ã„é †)
        </option>
        <option value="taken_at_desc" {% if request.args.get('sort')=='taken_at_desc' %}selected{% endif %}>æ’®å½±æ—¥ (æ–°ã—ã„é †)
        </option>
        <option value="taken_at_asc" {% if request.args.get('sort')=='taken_at_asc' %}selected{% endif %}>æ’®å½±æ—¥ (å¤ã„é †)
        </option>
      </select>
    </form>
  </div>
</div>

<!-- Masonry Grid -->
<div class="masonry-grid">
  {% for m in media_list %}
  <div class="grid-item fade-in" style="animation-delay: {{ loop.index0 * 0.05 }}s" data-id="{{ m.id }}">

    <!-- Menu -->
    <!-- Logic for edit/delete pending implementation in media_bp -->
    <!-- 
        <button class="menu-btn" type="button">â‹¯</button>
        <div class="menu-dropdown">
           ...
        </div>
        -->

    <!-- Media -->
    <!-- Determine type helper in template or model property -->
    {% set m_type = 'video' if m.mime_type.startswith('video') else 'image' %}

    <div class="media-wrapper media-trigger" data-type="{{ m_type }}"
      data-src="{{ url_for('media.serve_file', filename=m.filename) }}" data-description="{{ m.description or '' }}"
      data-uploader="{{ m.uploader.display_name or m.uploader.name or 'Unknown' }}"
      data-date="{{ m.created_at|friendly_date }}" onclick="openLightbox({{ loop.index0 }})">

      <!-- Taken Date Badge (Memory Date) -->
      {% if m.taken_at %}
      <div class="memory-date-badge">
        ğŸ“… {{ m.taken_at|friendly_date }}
      </div>
      {% endif %}

      <!-- Favorite Button -->
      <!-- Check if current user favorited this media -->
      {% set is_fav = current_user in m.favorited_by %}
      <button class="favorite-btn {{ 'active' if is_fav else '' }}" onclick="toggleFavorite('{{ m.id }}', event)">
        {{ 'â™¥' if is_fav else 'â™¡' }}
      </button>

      {% if m_type == "image" %}
      <img class="grid-media" src="{{ url_for('media.serve_file', filename=m.filename) }}" loading="lazy" alt="">
      {% elif m_type == "video" %}
      {% set thumb = m.thumbnail_path and url_for('media.serve_thumbnail', filename=m.thumbnail_path) or
      url_for('media.serve_file',
      filename=m.filename) %}
      <img class="grid-media" src="{{ thumb }}" loading="lazy" alt="Video Thumbnail">
      <div class="play-icon">â–¶</div>
      <div class="video-badge">VIDEO</div>
      {% endif %}
    </div>

    <!-- Info -->
    <div class="item-info" style="position: relative;">
      <div style="display: flex; gap: 10px; align-items: center;">

        <!-- Avatar -->
        <div class="uploader-avatar"
          style="width: 36px; height: 36px; flex-shrink: 0; border-radius: 50%; overflow: hidden; background: #eee;">
          {% if m.uploader and m.uploader.avatar_url %}
          <img src="{{ url_for('media.serve_file', filename=m.uploader.avatar_url) }}" alt="{{ m.uploader.name }}"
            style="width: 100%; height: 100%; object-fit: cover;">
          {% else %}
          <div
            style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 18px;">
            ğŸ‘¤</div>
          {% endif %}
        </div>

        <!-- Text Content -->
        <div style="flex: 1; min-width: 0;">
          <!-- Header: Name & Date -->
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; flex-direction: column; align-items: flex-start; line-height: 1.3;">
              <span
                style="font-weight: 600; font-size: 12px; color: var(--text-primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100%;">
                {{ m.uploader.display_name or m.uploader.name or 'Unknown' }}
              </span>
              <span style="font-size: 10px; color: var(--text-secondary); white-space: nowrap;">
                {{ m.created_at|friendly_date }}
              </span>
            </div>

            <!-- Edit Button (Small icon) -->
            {% if current_user.is_family %}
            <button class="edit-btn" title="ç·¨é›†" onclick="openEditModal('{{ m.id }}', event)"
              style="background: none; border: none; cursor: pointer; padding: 0; font-size: 14px; opacity: 0.6; transition: opacity 0.2s;">
              âœï¸
            </button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Infinite Scroll Sentinel -->
<div id="scroll-sentinel" style="height: 50px; text-align: center; color: #999; margin-top: 20px;"></div>

{% endblock %}

{% block scripts %}
<script>
  // Reuse inherited scripts block if defined in base, otherwise standard script tag
  // Assuming base.html includes app.js at bottom, but we can add inline here for now

  function openEditModal(mediaId, event) {
    // Prevent lightbox opening if clicked (event bubbling)
    if (event) event.stopPropagation();

    fetch(`/media/${mediaId}/details`)
      .then(res => res.json())
      .then(data => {
        document.getElementById('edit-media-id').value = data.id;
        document.getElementById('edit-description').value = data.description || '';

        // Set preview image logic
        const imgEl = document.getElementById('edit-preview-image');
        imgEl.style.display = 'none'; // Reset to hidden
        imgEl.src = '';

        if (data.mime_type && data.mime_type.startsWith('video')) {
          if (data.thumbnail_path) {
            imgEl.src = `/media/thumb/${data.thumbnail_path}`;
            // onload will handle display
          }
        } else if (data.filename) {
          imgEl.src = `/media/file/${data.filename}`;
          // onload will handle display
        }

        // Handle datetime formatting for input
        // data.taken_at might be ISO string "2023-12-23T15:00:00" or similar
        if (data.taken_at) {
          // Remove seconds/timezone if needed for datetime-local which expects "YYYY-MM-DDThh:mm"
          let val = data.taken_at;
          if (val.length > 16) val = val.substring(0, 16);
          document.getElementById('edit-taken-at').value = val;
        } else {
          document.getElementById('edit-taken-at').value = '';
        }

        const modal = document.getElementById('edit-modal');
        modal.classList.add('active'); // Reuse lightbox active class for visibility
        modal.style.opacity = '1';
        modal.style.visibility = 'visible';
      });
  }

  function closeEditModal() {
    const modal = document.getElementById('edit-modal');
    modal.classList.remove('active');
    modal.style.opacity = '0';
    modal.style.visibility = 'hidden';
  }

  function submitEdit(e) {
    e.preventDefault();
    const id = document.getElementById('edit-media-id').value;
    const desc = document.getElementById('edit-description').value;
    const date = document.getElementById('edit-taken-at').value;

    const formData = new FormData();
    formData.append('description', desc);
    formData.append('taken_at', date);

    fetch(`/media/${id}/update`, {
      method: 'POST',
      body: formData
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          showMessageModal('æ›´æ–°å®Œäº†', 'è©³ç´°ã‚’ä¿å­˜ã—ã¾ã—ãŸ', () => location.reload());
        } else {
          showErrorModal('æ›´æ–°å¤±æ•—: ' + data.error);
        }
      });
  }

  function deleteMedia() {
    showConfirmModal('æœ¬å½“ã«ã“ã®å†™çœŸ/å‹•ç”»ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ', function () {
      performDelete();
    });
  }

  function performDelete() {
    const id = document.getElementById('edit-media-id').value;

    // Close confirm modal first (optional)
    closeConfirmModal();

    fetch(`/media/${id}/delete`, {
      method: 'POST'
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          showMessageModal('å‰Šé™¤ã—ã¾ã—ãŸ', 'ãƒ•ã‚¡ã‚¤ãƒ«ã¯å®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚', () => location.reload());
        } else {
          showErrorModal('å‰Šé™¤å¤±æ•—: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(err => {
        console.error(err);
        showErrorModal('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      });
  }

  // Global modal logic moved to app.js

  function toggleFavorite(mediaId, event) {
    if (event) event.stopPropagation();

    const btn = event.currentTarget;

    // Optimistic UI update
    const wasActive = btn.classList.contains('active');
    btn.classList.toggle('active');
    btn.textContent = wasActive ? 'â™¡' : 'â™¥';

    fetch(`/media/${mediaId}/favorite`, {
      method: 'POST'
    })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          // Revert on error
          btn.classList.toggle('active');
          btn.textContent = wasActive ? 'â™¥' : 'â™¡';
          console.error(data.error);
        }
        // Success, nothing else to do
      })
      .catch(err => {
        btn.classList.toggle('active');
        btn.textContent = wasActive ? 'â™¥' : 'â™¡';
        console.error(err);
      });
  }
</script>
{% endblock %}
```